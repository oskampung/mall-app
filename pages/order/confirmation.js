(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/order/confirmation"],{"1c99":function(e,o,t){},"3c33":function(e,o,t){"use strict";(function(e){Object.defineProperty(o,"__esModule",{value:!0}),o.default=void 0;var n=t("4a45"),s=t("4be7"),i=t("7435"),a=t("0bc1"),u=function(){t.e("components/uni-popup/uni-popup-select").then(function(){return resolve(t("cc75"))}.bind(null,t)).catch(t.oe)},c={components:{uniPopupSelect:u},data:function(){return{baseUrl:n.requestURL,userId:null,buylist:[],goodsPrice:0,sumPrice:0,freight:0,note:"",int:0,deduction:0,provider:null,recinfo:{cityName:"",countyName:"",detailInfo:"",provinceName:"",contactPhone:"",contactUserName:"选择收件人",receiveInf:""},openId:"",authorization:null,code:"",orderId:"",amount:0,orderName:"",goodsId:"",channel:"wxpay",skuId:0,orderInfo:null,couponList:[],couponSeleted:null,couponValue:0,couponName:null,disabledCoupon:!0,couponId:null}},onShow:function(){var o=this;console.log("onShow"),e.getStorage({key:"buylist",success:function(e){o.buylist=e.data,o.goodsPrice=0,o.freight=0;for(var t=o.buylist.length,n=0;n<t;n++)o.freight=o.freight+o.buylist[n].freight,o.goodsPrice=o.goodsPrice+o.buylist[n].number*o.buylist[n].price;o.deduction=o.int/100,o.sumPrice=o.freight+o.goodsPrice-o.deduction,o.buildOrderInfo()}}),e.getStorage({key:"selectAddress",success:function(e){console.log(e),o.recinfo=e.data},fail:function(e){console.log("获取地址失败")}})},onHide:function(){console.log("onHide")},onLoad:function(){var o=this.provider;null!=o&&""!=o||(e.getProvider({service:"oauth",success:function(e){o=e.provider[0]}}),this.provider=o),this.channel="toutiao"==this.provider?"ALIPAY":"WXPAY",this.openId=e.getStorageSync("miniOpenId"),this.userId=e.getStorageSync("userId"),this.authorization=e.getStorageSync("Authorization"),this.getCouponList()},onBackPress:function(){this.clearOrder()},filters:{toFixed:function(e){return parseFloat(e).toFixed(2)}},methods:{isUsedCoupon:function(e){0==e.detail.value.length?(this.couponSeleted=null,this.sumPrice=this.sumPrice+parseFloat(this.couponValue),this.couponValue=0,this.couponId=null):(this.selectedCoupon(0),this.orderInfo.couponId=this.couponSeleted.id,this.couponId=this.couponSeleted.id),console.log(this.orderInfo)},open:function(){this.$refs.popup.open()},selectedCoupon:function(e){this.couponSeleted=this.couponList[e],this.checkCoupon(this.couponSeleted),this.disabledCoupon=this.couponValue>0},oauthLogin:function(o){var t=this,s=this.provider;console.log("开始登陆账号:"+s),e.login({provider:s,success:function(i){console.log(i);var a=getApp().globalData.PROVIDER[s];e.request({url:n.requestURL+"/auth/mobile/token/social?grant_type=mobile&mobile="+a+"@"+i.code,method:"post",header:{Authorization:getApp().globalData.CLIENT},success:function(n){200==n.statusCode&&(console.log(n),e.setStorageSync("Authorization","Bearer "+n.data.access_token),t.authorization="Bearer "+n.data.access_token,e.setStorageSync("TENANT-ID",n.data.tenant_id),e.setStorageSync("refreshToken",n.data.refresh_token),e.setStorageSync("refreshTokenTime",parseInt((new Date).getTime()/1e3)),e.setStorageSync("userId",n.data.user_id),e.setStorageSync("userName",n.data.username),o&&t.toPay())}})},fail:function(o){console.log("用户拒绝了授权: "+JSON.stringify(o)),e.hideLoading()}})},clearOrder:function(){var o=this;e.removeStorage({key:"buylist",success:function(e){o.buylist=[]}})},checkCoupon:function(o){var t=o;if(this.couponValue>0&&(this.sumPrice=this.sumPrice+parseFloat(this.couponValue),this.couponValue=0),"0"==o.stint)this.couponValue=o.value;else if("1"==o.stint){for(var n=0,s=0;s<this.buylist.length;s++)n+=parseFloat(this.buylist[s].price);n>o.stintQuota?this.couponValue=o.value:e.showToast({title:"订单金额不够扣减",icon:"none",duration:1500})}else if("2"==this.couponSeleted.stint){if(null!=this.couponSeleted.goods&&this.couponSeleted.goods.length>0){for(var i=0;i<this.buylist.length;i++)if(this.couponSeleted.goods.indexOf(this.buylist[i].id)>-1){this.couponValue=t.value;break}0==this.couponValue&&e.showToast({title:"没有可用的优惠券",icon:"none",duration:1500})}}else if("3"==this.couponSeleted.stint&&null!=this.couponSeleted.goodsCategory&&this.couponSeleted.goodsCategory.length>0){for(var a=0;a<this.buylist.length;a++)if(this.couponSeleted.goodsCategory.indexOf(this.buylist[a].category)>-1){this.couponValue=t.value;break}0==this.couponValue&&e.showToast({title:"产品品类不包含在优惠券内",icon:"none",duration:1500})}0==this.couponSeleted.type?this.sumPrice=this.sumPrice-parseFloat(this.couponValue):(this.couponValue=this.goodsPrice*this.couponValue*.1,this.sumPrice=this.sumPrice-parseFloat(this.couponValue).toFixed(2))},countOptimalCoupon:function(e){var o=e,t=0;if("0"==o.stint)t=o.value;else if("1"==o.stint){for(var n=0,s=0;s<this.buylist.length;s++)n+=parseFloat(this.buylist[s].price);n>o.stintQuota?t=o.value:(t=-1,console.log("限额不满足"))}else if("2"==o.stint){if(null!=o.goods&&o.goods.length>0){for(var i=0;i<this.buylist.length;i++)if(o.goods.indexOf(this.buylist[i].id)>-1){t=o.value;break}0==t&&(t=-2,console.log("产品不满足"))}}else if("3"==o.stint&&null!=o.goodsCategory&&o.goodsCategory.length>0){for(var a=0;a<this.buylist.length;a++)if(o.goodsCategory.indexOf(this.buylist[a].category)>-1){t=o.value;break}0==t&&(console.log("产品品类不满足"),t=-3)}return 0==o.type?t:this.goodsPrice*(.1*o.value)},checkOptimalCoupon:function(){for(var e=this.couponList,o=[],t=0;t<e.length;t++){var n=this.countOptimalCoupon(e[t]);this.couponList[t]["discount"]=parseFloat(n),o.push(parseFloat(n))}console.log(o),o.sort((function(e,o){return e<o})),console.log(o),this.couponList.sort((function(e,o){return e["discount"]<o["discount"]})),this.bubbleSort()},bubbleSort:function(){for(var e=this.couponList,o=e.length,t=0;t<o;t++)for(var n=0;n<o-1-t;n++)if(e[n].discount<e[n+1].discount){var s=e[n+1];e[n+1]=e[n],e[n]=s}this.couponList=e,this.selectedCoupon(0)},buildOrderInfo:function(){for(var o=this,t=[],n=[],s=this.buylist.length,i=0;i<s;i++)t.push(this.buylist[i]),n.push(this.buylist[i].id);for(var a=[],u=0;u<t.length;u++){var c={goodsId:t[u].id,goodsName:t[u].goodsName,skuId:t[u].skuId,skuName:t[u].specNames,number:t[u].number,img:t[u].coverImgs};a.push(c)}var r=e.getStorageSync("shareUserId"),l=e.getStorageSync("promotionChannels"),d={appId:getApp().globalData.wxAppId,appCode:getApp().globalData.APPNAME,paymentPrice:this.sumPrice,note:this.note,goodsPrice:this.goodsPrice,integral:this.int,deduction:this.deduction,receiveInf:"",specsNames:t[0].specNames,goodsId:t[0].id,skuId:t[0].skuId,shareUserId:r,goodsList:a,goodsid:n,couponId:this.couponId,promotionCh:""==l?"0":l};Object.assign(d,t[0],o.recinfo),this.orderInfo=d,console.log(d)},toPay:function(){for(var o=this,t=[],n=[],s=this.buylist.length,i=0;i<s;i++)t.push(this.buylist[i]),n.push(this.buylist[i].id);if(0!=t.length){e.showLoading({title:"正在提交订单..."});var u=e.getStorageSync("address");if(""==u||null==u)return this.selectAddress(),e.hideLoading(),!1;var c=o.orderInfo;if(Object.assign(c,u),this.deleteProperties(c),null!=this.couponSeleted&&(c.couponId=this.couponSeleted.id),c.paymentPrice<.01)return e.showToast({title:"订单金额有误，请确认订单",icon:"none"}),!1;console.log(c),(0,a.saveOrder)(c).then((function(n){return 401==n.statusCode?(o.oauthLogin(!0),!1):0==n.data.code&&null!=n.data.data?(c.id=n.data.data.id,o.amount=n.data.data.paymentPrice,void e.setStorage({key:"paymentOrder",data:t,success:function(){o.goodsId=c.goodsId,o.orderName=c.goodsName,o.orderId=c.id,o.skuId=c.skuId,o.doDeposit()}})):void e.showToast({title:n.data.msg,icon:"none"})}))}else e.showToast({title:"订单信息有误，请重新购买",icon:"none"})},doDeposit:function(){var o=this,t=this.provider;if(e.showLoading({title:"开始下单..."}),"toutiao"==t)return this.payment(null),!1;console.log(this.openId),""==this.openId?(console.log("开始获取OpenID:"+t),e.login({provider:t,success:function(n){console.log(n);var i={code:n.code,state:getApp().globalData.PROVIDER[t]};(0,s.getOpenId)(i).then((function(t){0==t.data.code?(o.openId=t.data.data,e.setStorageSync("miniOpenId",t.data.data),o.payment(t.data.data)):console.log(t)}))},fail:function(e){console.log("登录失败"),console.log(e)}})):this.payment(this.openId)},payment:function(o){var t=this,n=this.channel,s=parseFloat(this.amount).toFixed(2),i={appId:getApp().globalData.wxAppId,appCode:getApp().globalData.APPNAME,amount:100*s,goodsName:this.orderName,openId:o,goodsId:this.goodsId+"",userId:this.userId,orderId:this.orderId,skuId:this.skuId,channel:this.channel,payType:"WXPAY"==this.channel?"JSAPI":"APP"};(0,a.addPaymentOrder)(i).then((function(o){401==o.statusCode&&t.oauthLogin(!0),0==o.data.code?"WXPAY"==n?t.wxPay(o.data.data.params,s):t.ttPay(o.data.data.params,s):e.showToast({title:o.data.msg?o.data.msg:"下单失败",icon:"none"})})).catch((function(o){e.showToast({title:"下单失败",icon:"none"})}))},wxPay:function(o,t){var n=this;e.showLoading({title:"正在支付..."}),wx.requestPayment({timeStamp:o.timeStamp,nonceStr:o.nonceStr,package:o.package,signType:"MD5",paySign:o.paySign,success:function(o){console.log("支付成功"),console.log(o),e.showToast({title:"支付成功",icon:"success"}),e.redirectTo({url:"/pages/pay/success/success?amount="+t})},fail:function(o){console.log("支付失败"),console.log(o),e.showToast({title:"支付失败",icon:"none"}),e.redirectTo({url:"/pages/user/order_list/order_detail?oid="+n.orderId}),e.hideLoading()},complete:function(o){console.log("支付完成"),e.hideLoading()}})},ttPay:function(e,o){tt.pay({orderInfo:e,service:1,getOrderStatus:function(e){e.out_order_no;return new Promise((function(e,o){tt.request({url:"<your-backend-url>",success:function(o){e({code:11})},fail:function(e){o(e)}})}))},success:function(e){0==e.code&&(console.log("支付成功"),console.log(e))},fail:function(e){console.log("支付fail"),console.log(e)}})},getCouponList:function(){var e=this,o={userId:this.userId,status:"0"};(0,i.getCouponList)(o).then((function(o){0==o.data.code&&null!=o.data.data&&(e.couponList=o.data.data,e.couponList.length>0&&e.checkOptimalCoupon())}))},selectAddress:function(){var o=this;"weixin"!=this.provider&&"toutiao"!=this.provider||e.chooseAddress({success:function(t){var n={cityName:t.cityName,countyName:t.countyName,detailInfo:t.detailInfo,provinceName:t.provinceName,contactPhone:t.telNumber,contactUserName:t.userName,nationalCode:t.nationalCode,receiveInf:t.provinceName+" "+t.cityName+" "+t.countyName};console.log(this);var s=[];e.getStorage({key:"addressList",success:function(e){s=e.data,s.push(n)}}),e.setStorageSync("addressList",s),e.setStorageSync("address",n),e.setStorageSync("selectAddress",n),o.recinfo=n,Object.assign(o.orderInfo,n)},fail:function(o){console.log("获取地址失败了"),console.log(o),e.showModal({title:"未获取到通讯地址授权",content:"请打开顶部菜单->设置->允许访问通讯地址",showCancel:!1,success:function(e){console.log("已提示打开授权")}})}})},deleteProperties:function(e){delete e.releaseTime,delete e.updateTime,delete e.status,delete e.slogan,delete e.img,delete e.salesNum,delete e.inventory,delete e.id},checkUserSession:function(){console.log("获取到的UserId:"+this.userId)}}};o.default=c}).call(this,t("543d")["default"])},"855a":function(e,o,t){"use strict";t.r(o);var n=t("c430"),s=t("bf25");for(var i in s)"default"!==i&&function(e){t.d(o,e,(function(){return s[e]}))}(i);t("eec3");var a,u=t("f0c5"),c=Object(u["a"])(s["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],a);o["default"]=c.exports},"8e35":function(e,o,t){"use strict";(function(e){t("1822");n(t("66fd"));var o=n(t("855a"));function n(e){return e&&e.__esModule?e:{default:e}}e(o.default)}).call(this,t("543d")["createPage"])},bf25:function(e,o,t){"use strict";t.r(o);var n=t("3c33"),s=t.n(n);for(var i in n)"default"!==i&&function(e){t.d(o,e,(function(){return n[e]}))}(i);o["default"]=s.a},c430:function(e,o,t){"use strict";var n={"uni-popup":function(){return Promise.all([t.e("common/vendor"),t.e("components/uni-popup/uni-popup")]).then(t.bind(null,"38ef"))}},s=function(){var e=this,o=e.$createElement,t=(e._self._c,e._f("toFixed")(e.deduction)),n=e._f("toFixed")(e.goodsPrice),s=e._f("toFixed")(e.couponValue),i=e._f("toFixed")(e.deduction),a=e._f("toFixed")(e.freight),u=e._f("toFixed")(e.sumPrice);e.$mp.data=Object.assign({},{$root:{f0:t,f1:n,f2:s,f3:i,f4:a,f5:u}})},i=[];t.d(o,"b",(function(){return s})),t.d(o,"c",(function(){return i})),t.d(o,"a",(function(){return n}))},eec3:function(e,o,t){"use strict";var n=t("1c99"),s=t.n(n);s.a}},[["8e35","common/runtime","common/vendor"]]]);